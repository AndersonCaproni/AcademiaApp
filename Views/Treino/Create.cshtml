@model TreinoCreateViewModel
@using Microsoft.AspNetCore.Identity
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager

@{
    Layout = "~/Views/Personal/_LayoutPersonal.cshtml";
    ViewData["Title"] = "Criar Treino";
}

<h2 class="mb-4">➕ Criar Novo Treino</h2>

<div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-4">
        <form asp-action="Create" method="post">
            <div class="mb-3">
                <label asp-for="AlunoId" class="form-label fw-semibold">Aluno</label>
                <select asp-for="AlunoId" class="form-select rounded-3" asp-items="@(new SelectList(ViewBag.Alunos, "Id", "Nome"))">
                    <option value="" selected disabled>Selecione um aluno</option>
                </select>
                <span asp-validation-for="AlunoId" class="text-danger small"></span>
            </div>

            <div class="mb-3">
                <label asp-for="DataTreino" class="form-label fw-semibold">Data e Hora do Treino</label>
                <input asp-for="DataTreino" class="form-control rounded-3" type="datetime-local" />
                <span asp-validation-for="DataTreino" class="text-danger small"></span>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Exercícios</label>
                <div class="ms-2">
                    @for (var i = 0; i < Model.ExerciciosDisponiveis.Count; i++)
                    {
                        var exercicio = Model.ExerciciosDisponiveis[i];
                        var isChecked = Model.ExerciciosSelecionados?.Any(e => e.Id.ToString() == exercicio.Value) == true;
                        <div class="form-check mb-2">

                            <input class="form-check-input"
                                   type="checkbox"
                                   name="ExerciciosSelecionados[@i].Id"
                                   value="@exercicio.Value"
                                   id="checkbox_@i"
                                   data-index="@i"
                                   data-exercicio-value="@exercicio.Value"
                            @(isChecked ? "checked" : "") />

                            <label class="form-check-label" for="checkbox_@i">
                                @exercicio.Text
                            </label>

                            <div class="ms-4 mt-2 d-none" id="inputs_@i">
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <label class="form-label small mb-1" for="series_@i">Séries</label>
                                        <input type="number" class="form-control form-control-sm"
                                               id="series_@i"
                                               name="ExerciciosSelecionados[@i].qtdSeries"
                                               disabled
                                               min="1" placeholder="Qtd. séries" />
                                    </div>

                                    <div class="col-6">
                                        <label class="form-label small mb-1" for="repeticoes_@i">Repetições</label>
                                        <input type="number" class="form-control form-control-sm"
                                               id="repeticoes_@i"
                                               name="ExerciciosSelecionados[@i].qtdRepeticoes"
                                               disabled
                                               min="1" placeholder="Qtd. repetições" />
                                    </div>
                                </div>
                            </div>

                        </div>
                        <hr/>
                    }
                </div>
                <span asp-validation-for="ExerciciosSelecionados" class="text-danger small"></span>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-outline-primary rounded-pill px-4">
                    💾 Salvar
                </button>
                <a class="btn btn-outline-secondary rounded-pill px-4" asp-controller="Treino" asp-action="ListarPorPersonal" asp-route-id="@UserManager.GetUserId(User)">
                    ❌ Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.form-check-input[type="checkbox"]').forEach(function (checkbox) {
                var index = checkbox.dataset.index;
                var inputsDiv = document.getElementById('inputs_' + index);
                var inputs = inputsDiv.querySelectorAll('input');

                function updateInputs() {
                    if (checkbox.checked) {
                        inputsDiv.classList.remove('d-none');
                        inputs[0].disabled = false;
                        inputs[1].disabled = false;

                        inputs[0].required = true;
                        inputs[1].required = true;

                        checkbox.name = `ExerciciosSelecionados[${index}].Id`;
                        inputs[0].name = `ExerciciosSelecionados[${index}].qtdSeries`;
                        inputs[1].name = `ExerciciosSelecionados[${index}].qtdRepeticoes`;

                        checkbox.value = checkbox.dataset.exercicioValue;
                    } else {
                        inputsDiv.classList.add('d-none');
                        inputs.forEach(input => {
                            input.value = '';
                            input.disabled = true;
                            input.required = false;
                            input.removeAttribute('name');
                        });
                        checkbox.removeAttribute('name');
                    }
                }

                updateInputs();
                checkbox.addEventListener('change', updateInputs);
            });

            var form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function () {
                    document.querySelectorAll('input:disabled').forEach(function (input) {
                        input.disabled = false;
                    });
                });
            }
        });
    </script>
}

